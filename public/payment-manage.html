<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
     * {
      box-sizing: border-box;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container my-4">
    <h2 class="text-center mb-4">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h2>
    <div id="paymentList"></div>
  </div>

  <script>
    async function fetchPayments() {
      const res = await fetch('/api/payments/all');
      let payments = await res.json();

      const container = document.getElementById('paymentList');
      container.innerHTML = '';

      payments.reverse().forEach(p => {
        const now = new Date();
        let status = p.status;
        let bgClass = 'bg-light';

        if (p.status === 'approved' && p.validTill && new Date(p.validTill) < now) {
          status = 'pending';
        }

        if (status === 'approved') bgClass = 'bg-success text-white';
        else if (status === 'declined') bgClass = 'bg-danger text-white';
        else if (status === 'pending') bgClass = 'bg-warning';

        const uniqueInputId = `validTillInput_${p._id}`;

        const div = document.createElement('div');
        div.className = `card mb-3 p-3 ${bgClass}`;

        div.innerHTML = `
          <strong>${p.name} (üìû ${p.phone})</strong><br>
          <small>‡¶ï‡ßã‡¶∞‡ßç‡¶∏: ${p.courseTitle} (${p.courseId})</small><br>
          <small>‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø: ${p.coursePrice} ‡¶ü‡¶æ‡¶ï‡¶æ</small><br>
          <small>‡¶á‡¶Æ‡ßá‡¶á‡¶≤: ${p.email}</small><br>
          <small>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${new Date(p.createdAt).toLocaleDateString()}</small><br>
          <small>‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü: ${p.paymentMethod} (${p.paymentPhone})</small><br>
          <small>TXN ID: ${p.transactionId}</small><br>
          <small>‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶∂‡ßá‡¶∑: ${p.validTill ? new Date(p.validTill).toLocaleDateString() : 'N/A'}</small><br>
          <strong>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏:</strong> ${status}<br><br>

          <label>‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ (‡¶¶‡¶ø‡¶®):</label>
          <input type="number" id="${uniqueInputId}" class="form-control" placeholder="‡¶Æ‡ßá‡ßü‡¶æ‡¶¶ ‡¶¶‡¶ø‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®‡¶É 180)" />
          <button class="btn btn-success btn-sm me-2" onclick="updateStatus('${p._id}', 'approved', '${uniqueInputId}')">Approve</button>
          <button class="btn btn-danger btn-sm" onclick="updateStatus('${p._id}', 'declined')">Decline</button>
        `;

        container.appendChild(div);
      });
    }

    async function updateStatus(id, status, inputId = null) {
      let validTill;

      if (status === 'approved') {
        const daysInput = document.getElementById(inputId)?.value;
        const days = parseInt(daysInput);

        const d = new Date();
        if (!isNaN(days) && days > 0) {
          d.setDate(d.getDate() + days);
        } else {
          d.setDate(d.getDate() + 180); // default 6 ‡¶Æ‡¶æ‡¶∏
        }

        validTill = d.toISOString();
      }

      const res = await fetch('/api/payments/update-status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, status, validTill })
      });

      const data = await res.json();
      if (res.ok) {
        alert("‚úÖ Okay");
        fetchPayments();
      } else {
        alert("‚ùå ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá");
      }
    }

    fetchPayments();
  </script>

  <script>

  // here all is ok.
const loggedInUser = JSON.parse(localStorage.getItem('user'));
const token = localStorage.getItem('token');

if (!loggedInUser || !token || loggedInUser.role !== 'admin') {
  // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßá‡¶®‡¶ø ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶∞‡ßã‡¶≤ 'admin' ‡¶®‡¶æ
  window.location.href = '/home.html'; // ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶®‡ßã ‡¶®‡ßã ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶™‡ßá‡¶ú
} else {
  console.log("‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞:", loggedInUser);
  // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßá‡¶ú ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡ßã
}

</script>
</body>
</html>
